@using PartyGuide.Domain.Models;
@model ServiceModel
@{
	ViewData["Title"] = "Service Catalog";
}

<div class="container mt-5">
	<div class="row">

		<!-- Main Panel (left side) -->
		<div class="col-md-8">
			<div class="card mb-4">
				<div class="card-header bg-primary text-white">
					<h3 class="card-title">@Model.Title</h3>
				</div>
				<div class="card-body">
					@if (Model.Image != null && Model.Image.Length > 0)
					{
						<img src="@($"data:image/png;base64,{Convert.ToBase64String(Model.Image)}")" class="card-img-top img-fluid mb-4" alt="@Model.Title" style="object-fit: cover;">
					}
					<p class="card-text"><strong>Description:</strong><br />@Model.Description</p>
					<p class="card-text"><strong>Phone:</strong> @Model.PhoneNumber</p>
					<p class="card-text"><strong>Price Range:</strong> $@Model.StartPriceRange - $@Model.EndPriceRange</p>
					<p class="card-text"><strong>Location:</strong> @Model.Location</p>
				</div>
			</div>
		</div>

		<!-- Additional Information and Contact the Seller Panels (right side) -->
		<div class="col-md-4">
			<div class="card mb-4">
				<div class="card-header bg-secondary text-white">
					<h4 class="card-title">Additional Information</h4>
				</div>
				<div class="card-body">
					<!-- Add additional information here -->
					<p class="card-text">@Model.ExtendedDescription</p>
				</div>
			</div>

			<div class="card mb-4">
				<div class="card-header bg-info text-white">
					<h4 class="card-title">Contact the Seller</h4>
				</div>
				<div class="card-body">
					<p class="card-text">If you're interested in this service, feel free to contact the seller for more details or to make arrangements.</p>
					<button class="btn btn-primary">Contact Seller</button>
				</div>
			</div>

			<!-- Google Meets Panel (right side) -->

			<div class="card mb-4">
				<div class="card-header bg-success text-white">
					<h4 class="card-title">Arrange a Meeting</h4>
				</div>
				<div class="card-body">
					<div id="google-meet" style="height: 300px;"></div>
				</div>
			</div>

			<!-- Ratings Panel (right side) -->

			<form id="ratingForm" data-service-id="@Model.Id">
				<input type="hidden" name="serviceId" value="@Model.Id" />
				<label for="rating">Rate this service:</label>
				<select name="rating" id="rating">
					<option value="1">1 star</option>
					<option value="2">2 stars</option>
					<option value="3">3 stars</option>
					<option value="4">4 stars</option>
					<option value="5">5 stars</option>
				</select>
				@*<button type="button" id="submitRating">Submit</button>*@
			</form>
		</div>
	</div>
</div>

<div class="container mt-5">
	<!-- Add a Service Card -->
	<div class="card">
		<div class="card-header">
			Add a Service
		</div>
		<div class="card-body">
			<!-- Star Rating Section -->
			<div class="mb-3">
				<h5 class="card-title">Rate this Service</h5>
				<div class="rating">
					<input type="radio" id="star5" name="rating" value="5" /><label for="star5" title="5 stars"></label>
					<input type="radio" id="star4" name="rating" value="4" /><label for="star4" title="4 stars"></label>
					<input type="radio" id="star3" name="rating" value="3" /><label for="star3" title="3 stars"></label>
					<input type="radio" id="star2" name="rating" value="2" /><label for="star2" title="2 stars"></label>
					<input type="radio" id="star1" name="rating" value="1" /><label for="star1" title="1 star"></label>
				</div>
			</div>
			<!-- Input Field -->
			<div class="mb-3">
				<label for="comment" class="form-label">Comment:</label>
				<input type="text" class="form-control" id="comment" placeholder="Add your comment..." />
			</div>
			<!-- Submit Button -->
			<button type="button" id="submitRating" class="btn btn-primary float-end">Submit</button>
		</div>
	</div>
	<!-- Reviews List Card -->
	<div class="card mt-4">
		<div class="card-header">
			Service Reviews
		</div>
		<div class="card-body">
			<div class="rating">
				@if (Model.Ratings != null && Model.Ratings.Any())
				{
					var averageRating = Model.Ratings.Average(r => r.Rating);
					for (int i = 1; i <= 5; i++)
					{
						<span class="fa fa-star @(i <= averageRating ? "checked" : "")"></span>
					}
					<span>(@Model.Ratings.Count reviews)</span>

					<div class="individual-reviews mt-3">
						<h5>Individual Reviews:</h5>
						@foreach (var review in Model.Ratings)
						{
							<div class="card mb-3">
								<div class="card-header">
									Reviewer: @review.UserId
								</div>
								<div class="card-body">
									<p class="card-text">
										Rating:
										@for (int i = 1; i <= 5; i++)
										{
											<span class="fa fa-star @(i <= averageRating ? "checked" : "")"></span>
										}
									</p>
									<p class="card-text">Comment: @review.Comment</p>
								</div>
							</div>
						}
					</div>
				}
				else
				{
					<span>No reviews yet</span>
				}
			</div>
		</div>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
	$(document).ready(function () {
		$("#submitRating").on("click", function () {
			var serviceId = $("#ratingForm").data("service-id");
			var ratingValue = $("#rating").val();

			$.ajax({
				url: "@Url.Action("RateService", "Service")",
				method: "POST",
				data: { serviceId: serviceId, rating: ratingValue },
				success: function (data) {
					if (data.success) {
						// Update the rating container with the new rating
						$("#ratingContainer").html("Rating submitted successfully!");
					} else {
						// Display error message
						alert("Error: " + data.errorMessage);
					}
				},
				error: function () {
					// Handle errors
					alert("An error occurred while submitting the rating.");
				}
			});
		});
	});
</script>
